---
version: 2
jobs:
  pr_check:
    docker:
      - image: circleci/openjdk:8-jdk
      - image: maven
    steps:
    - checkout #check out source code
    - run:
        name: Install packages
        command: sudo apt-get update && sudo apt-get install -y zip && sudo apt-get install -y python-pip
    - run:
        name: maven build
        command: mvn clean install && pwd && ls -al && ls -al target/
    - setup_remote_docker
    - run:
        name: login docker 
        command: docker login --username $DOCKER_USER --password $DOCKER_PASS
    - run:
        name: create docker image
        command: docker build -t prernsha/webappimage:0.1.${CIRCLE_BUILD_NUM} -f images/Dockerfile && 
                 docker push prernsha/webappimage:0.1.${CIRCLE_BUILD_NUM}

  build_deploy:
    docker:
      - image: circleci/openjdk:8-jdk
      - image: maven
    steps:
    - checkout #check out source code
    - run:
        name: Install packages
        command: sudo apt-get update &&
                 sudo apt-get install -y python-pip
    - run:
        name: maven build
        command: mvn clean install && pwd && ls -al && ls -al target/
    
workflows:
  version: 2
  pr-check-workflow:
    jobs:
    - pr_check
  build-deploy-workflow:
    jobs:
    - build_deploy:
        filters:
          branches:
            only: master